---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllDecks, getTagsByCategory } from '../lib/decks';
import type { Deck } from '../types/deck';

const decks = getAllDecks();
const organicTags = getTagsByCategory('Organic');
const aiTags = getTagsByCategory('AI');

const langNames: Record<string, string> = {
  en: 'EN', fr: 'FR', de: 'DE', es: 'ES', fi: 'FI'
};
---

<BaseLayout title="Browse Decks" showSearch={true}>
  <div class="container">
    <div class="category-switcher">
      <button type="button" class="category-btn active" data-category="Organic">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v20M2 12h20"/>
        </svg>
        Organic
      </button>
      <button type="button" class="category-btn" data-category="AI">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2a2 2 0 0 0-2 2c0 .74.4 1.39 1 1.73V7h2V5.73c.6-.34 1-.99 1-1.73a2 2 0 0 0-2-2Z"/>
          <path d="M14 22v-1.5"/>
          <path d="M10 22v-1.5"/>
          <path d="m7 19-2 3"/>
          <path d="m17 19 2 3"/>
          <path d="M9 17h6"/>
          <path d="M9 14h6"/>
          <circle cx="12" cy="11" r="5"/>
        </svg>
        AI
      </button>
    </div>

    <div class="toolbar">
      <div class="tag-filters" id="tag-filters">
        <div class="organic-tags" data-category="Organic">
          {organicTags.map(tag => (
            <button type="button" class="tag-btn" data-tag={tag}>{tag}</button>
          ))}
        </div>
        <div class="ai-tags" data-category="AI" style="display: none;">
          {aiTags.map(tag => (
            <button type="button" class="tag-btn" data-tag={tag}>{tag}</button>
          ))}
        </div>
      </div>
    </div>

    <div class="results-bar">
      <span id="count">{decks.length} decks</span>
      <button type="button" id="clear-filters" class="clear-btn" hidden>Clear filters</button>
    </div>

    <div class="grid" id="grid">
      {decks.map((deck) => (
        <article class="card" data-title={deck.title.toLowerCase()} data-tags={deck.tags.join(',')} data-description={(deck.description || '').toLowerCase()} data-category={deck.category || 'Organic'}>
          <a href={`/deck/${deck.slug}`}>
            <div class="card-cover">
              <img src={deck.assets.cover} alt="" loading="lazy" onerror="this.src='/placeholder-cover.svg'" />
              <span class="lang-badge">{langNames[deck.language] || deck.language.toUpperCase()}</span>
            </div>
            <div class="card-body">
              <h2>{deck.title}</h2>
              {deck.uploadedAt && (
                <time class="card-date" datetime={deck.uploadedAt}>
                  {new Date(deck.uploadedAt).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                </time>
              )}
              <div class="card-tags">
                {deck.tags.slice(0, 3).map(t => <span class="tag">{t}</span>)}
              </div>
              {deck.legacyStats && (
                <div class="card-stats">
                  <span title="Views">üëÅÔ∏è {deck.legacyStats.views.toLocaleString()}</span>
                  <span title="Downloads">‚¨áÔ∏è {deck.legacyStats.downloads.toLocaleString()}</span>
                  <span title="Likes">‚ô• {deck.legacyStats.likes.toLocaleString()}</span>
                </div>
              )}
            </div>
          </a>
        </article>
      ))}
    </div>

    <p id="no-results" class="no-results" hidden>No decks match your search.</p>
  </div>
</BaseLayout>

<style>
  .category-switcher {
    display: flex;
    justify-content: center;
    gap: 0;
    padding: 1.5rem 0;
    margin-bottom: 0.5rem;
  }

  .category-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    font-size: 0.9375rem;
    font-weight: 600;
    background: var(--color-surface);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }

  .category-btn:first-child {
    border-radius: 9999px 0 0 9999px;
    border-right-width: 0.5px;
  }

  .category-btn:last-child {
    border-radius: 0 9999px 9999px 0;
    border-left-width: 0.5px;
  }

  .category-btn:hover {
    background: var(--color-bg);
    z-index: 1;
  }

  .category-btn.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
    z-index: 2;
  }

  .category-btn svg {
    width: 16px;
    height: 16px;
  }

  /* AI category button glow effect when active */
  .category-btn[data-category="AI"].active {
    box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
  }

  .toolbar {
    padding: 1.25rem 0;
    border-bottom: 1px solid var(--color-border);
  }

  .tag-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .tag-btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    background: var(--color-surface);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
    border-radius: 9999px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .tag-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }
  .tag-btn.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .results-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0;
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }
  .clear-btn {
    background: none;
    border: none;
    color: var(--color-primary);
    font-size: 0.875rem;
    cursor: pointer;
    padding: 0;
  }
  .clear-btn:hover { text-decoration: underline; }
  .clear-btn[hidden] { display: none; }

  .grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.25rem;
  }

  .card {
    background: var(--color-surface);
    border-radius: 0.75rem;
    overflow: hidden;
    border: 1px solid var(--color-border);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }
  .card a {
    display: block;
    text-decoration: none;
    color: inherit;
  }
  .card-cover {
    position: relative;
    aspect-ratio: 16/9;
    background: linear-gradient(135deg, #667eea, #764ba2);
  }
  .card-cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .lang-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.2rem 0.5rem;
    background: rgba(0,0,0,0.65);
    color: white;
    font-size: 0.7rem;
    font-weight: 600;
    border-radius: 0.25rem;
  }
  .card-body {
    padding: 0.875rem;
  }
  .card-body h2 {
    margin: 0 0 0.375rem;
    font-size: 0.9375rem;
    font-weight: 600;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .card-date {
    display: block;
    font-size: 0.75rem;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }
  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }
  .tag {
    padding: 0.2rem 0.5rem;
    background: var(--color-bg);
    color: var(--color-text-muted);
    font-size: 0.7rem;
    font-weight: 500;
    border-radius: 0.25rem;
  }

  .card-stats {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
    font-size: 0.7rem;
    color: var(--color-text-muted);
  }
  .card-stats span {
    display: inline-flex;
    align-items: center;
    gap: 0.2rem;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
  }
  .no-results[hidden] { display: none; }

  @media (max-width: 600px) {
    .hero h1 { font-size: 1.5rem; }
    .grid { grid-template-columns: 1fr; }
  }
</style>

<script>
  const grid = document.getElementById('grid')!;
  const cards = grid.querySelectorAll<HTMLElement>('.card');
  const searchInput = document.getElementById('search') as HTMLInputElement;
  const tagFiltersContainer = document.getElementById('tag-filters')!;
  const categoryBtns = document.querySelectorAll<HTMLButtonElement>('.category-btn');
  const countEl = document.getElementById('count')!;
  const noResults = document.getElementById('no-results')!;
  const clearBtn = document.getElementById('clear-filters') as HTMLButtonElement;

  let query = '';
  let activeTags = new Set<string>();
  let activeCategory = 'Organic';

  function setTheme(category: string) {
    if (category === 'AI') {
      document.documentElement.setAttribute('data-theme', 'ai');
    } else {
      document.documentElement.removeAttribute('data-theme');
    }
  }

  function updateTagFilters(category: string) {
    const organicTags = tagFiltersContainer.querySelector<HTMLElement>('.organic-tags');
    const aiTags = tagFiltersContainer.querySelector<HTMLElement>('.ai-tags');
    
    if (category === 'AI') {
      if (organicTags) organicTags.style.display = 'none';
      if (aiTags) aiTags.style.display = '';
    } else {
      if (organicTags) organicTags.style.display = '';
      if (aiTags) aiTags.style.display = 'none';
    }
  }

  function filter() {
    let visible = 0;
    const q = query.toLowerCase();

    cards.forEach(card => {
      const title = card.dataset.title || '';
      const description = card.dataset.description || '';
      const tags = (card.dataset.tags || '').split(',').filter(Boolean);
      const category = card.dataset.category || 'Organic';

      const matchQ = !q || title.includes(q) || description.includes(q) || tags.some(t => t.includes(q));
      const matchT = activeTags.size === 0 || tags.some(t => activeTags.has(t));
      const matchC = category === activeCategory;

      const show = matchQ && matchT && matchC;
      card.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    countEl.textContent = `${visible} deck${visible !== 1 ? 's' : ''}`;
    noResults.hidden = visible > 0;
    clearBtn.hidden = !query && activeTags.size === 0;
  }

  searchInput.addEventListener('input', () => {
    query = searchInput.value.trim();
    filter();
  });

  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.dataset.category!;
      activeCategory = category;

      // Update active state
      categoryBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Switch theme
      setTheme(category);

      // Switch tag filters
      updateTagFilters(category);

      // Clear filters when switching categories
      query = '';
      searchInput.value = '';
      activeTags.clear();
      
      // Re-attach event listeners to new tag buttons
      attachTagButtonListeners();

      filter();
    });
  });

  function attachTagButtonListeners() {
    const tagBtns = tagFiltersContainer.querySelectorAll<HTMLButtonElement>('.tag-btn');
    tagBtns.forEach(btn => {
      btn.replaceWith(btn.cloneNode(true));
    });
    
    const newTagBtns = tagFiltersContainer.querySelectorAll<HTMLButtonElement>('.tag-btn');
    newTagBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const tag = btn.dataset.tag!;
        if (activeTags.has(tag)) {
          activeTags.delete(tag);
          btn.classList.remove('active');
        } else {
          activeTags.add(tag);
          btn.classList.add('active');
        }
        filter();
      });
    });
  }

  clearBtn.addEventListener('click', () => {
    query = '';
    searchInput.value = '';
    activeTags.clear();
    const tagBtns = tagFiltersContainer.querySelectorAll<HTMLButtonElement>('.tag-btn');
    tagBtns.forEach(btn => btn.classList.remove('active'));
    filter();
  });

  // Initialize
  attachTagButtonListeners();
  setTheme(activeCategory);
  updateTagFilters(activeCategory);
  filter();
</script>
