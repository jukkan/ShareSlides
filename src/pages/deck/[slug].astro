---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllDecks, getDeckBySlug } from '../../lib/decks';

export function getStaticPaths() {
  return getAllDecks().map((deck) => ({ params: { slug: deck.slug } }));
}

const { slug } = Astro.params;
const deck = getDeckBySlug(slug!);

if (!deck) {
  return Astro.redirect('/404');
}

const langNames: Record<string, string> = {
  en: 'English', fr: 'Français', de: 'Deutsch', es: 'Español', fi: 'Suomi'
};
const langDisplay = langNames[deck.language] || deck.language.toUpperCase();
---

<BaseLayout title={deck.title}>
  <div class="container">
    <nav class="breadcrumb">
      <a href="/">← Back to all decks</a>
    </nav>

    <article class="deck-page">
      <div class="cover" id="cover-image" data-pdf={deck.assets.pdf} role="button" tabindex="0" title="View slides">
        <img src={deck.assets.cover} alt="" onerror="this.src='/placeholder-cover.svg'" />
      </div>

      <div class="details">
        <h1>{deck.title}</h1>
        
        <div class="meta">
          <span class="lang">{langDisplay}</span>
        </div>

        {deck.description && (
          <p class="description">{deck.description}</p>
        )}

        <div class="tags">
          {deck.tags.map(tag => (
            <a href={`/?tag=${tag}`} class="tag">{tag}</a>
          ))}
        </div>

        {deck.legacyStats && (
          <div class="legacy-stats">
            <h3>Legacy stats {deck.legacyStats.capturedAt && <span class="captured-date">(captured {deck.legacyStats.capturedAt})</span>}</h3>
            <div class="stats-grid">
              <div class="stat">
                <span class="stat-value">{deck.legacyStats.views.toLocaleString()}</span>
                <span class="stat-label">Views</span>
              </div>
              <div class="stat">
                <span class="stat-value">{deck.legacyStats.downloads.toLocaleString()}</span>
                <span class="stat-label">Downloads</span>
              </div>
              <div class="stat">
                <span class="stat-value">{deck.legacyStats.likes.toLocaleString()}</span>
                <span class="stat-label">Likes</span>
              </div>
            </div>
          </div>
        )}

        <div class="actions">
          <button type="button" id="view-slides-btn" class="btn btn-primary" data-pdf={deck.assets.pdf}>
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            View slides
          </button>
          <a href={deck.assets.pdf} download class="btn btn-secondary">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            Download PDF
          </a>
          {deck.assets.pptx && (
            <a href={deck.assets.pptx} download class="btn btn-secondary">
              <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Download PPTX
            </a>
          )}
        </div>
      </div>
    </article>
  </div>

  <!-- Fullscreen PDF Viewer Modal -->
  <div id="viewer-modal" class="viewer-modal" hidden>
    <div class="viewer-container">
      <div class="viewer-header">
        <span class="viewer-title">{deck.title}</span>
        <div class="viewer-actions">
          <a href={deck.assets.pdf} download class="viewer-btn" title="Download PDF">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
          </a>
          <button type="button" id="close-viewer-btn" class="viewer-btn viewer-close" title="Close (Esc)">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="viewer-body">
        <iframe id="viewer-iframe" class="viewer-iframe" allowfullscreen></iframe>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  const viewBtn = document.getElementById('view-slides-btn') as HTMLButtonElement;
  const coverImage = document.getElementById('cover-image') as HTMLDivElement;
  const modal = document.getElementById('viewer-modal') as HTMLDivElement;
  const modalContainer = modal?.querySelector('.viewer-container') as HTMLDivElement;
  const closeBtn = document.getElementById('close-viewer-btn') as HTMLButtonElement;
  const iframe = document.getElementById('viewer-iframe') as HTMLIFrameElement;
  
  const pdfPath = viewBtn?.dataset.pdf;
  
  function openViewer() {
    if (!pdfPath) return;
    const viewerSrc = `/pdfjs/web/viewer.html?file=${encodeURIComponent(pdfPath)}`;
    iframe.src = viewerSrc;
    modal.hidden = false;
    document.body.style.overflow = 'hidden';
  }
  
  function closeViewer() {
    modal.hidden = true;
    document.body.style.overflow = '';
    iframe.src = '';
  }
  
  viewBtn?.addEventListener('click', openViewer);
  coverImage?.addEventListener('click', openViewer);
  coverImage?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      openViewer();
    }
  });
  closeBtn?.addEventListener('click', closeViewer);
  
  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.hidden) {
      closeViewer();
    }
  });
  
  // Close on backdrop click (outside the container)
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) {
      closeViewer();
    }
  });
</script>

<style>
  .breadcrumb {
    padding: 1.5rem 0;
  }
  .breadcrumb a {
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }
  .breadcrumb a:hover {
    color: var(--color-primary);
  }

  .deck-page {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2.5rem;
    padding-bottom: 3rem;
  }

  .cover {
    aspect-ratio: 16/9;
    background: linear-gradient(135deg, #667eea, #764ba2);
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .cover:hover {
    transform: scale(1.02);
    box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.15);
  }
  .cover:focus-visible {
    outline: 3px solid var(--color-primary);
    outline-offset: 3px;
  }
  .cover img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .details {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  h1 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
    line-height: 1.25;
  }

  .meta {
    display: flex;
    gap: 0.75rem;
    color: var(--color-text-muted);
    font-size: 0.875rem;
  }
  .lang {
    padding: 0.25rem 0.625rem;
    background: var(--color-bg);
    border-radius: 0.25rem;
    font-weight: 500;
  }

  .description {
    margin: 0;
    color: var(--color-text-muted);
    line-height: 1.6;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .tag {
    padding: 0.375rem 0.75rem;
    background: var(--color-bg);
    color: var(--color-text-muted);
    font-size: 0.8125rem;
    font-weight: 500;
    border-radius: 9999px;
    border: 1px solid var(--color-border);
    text-decoration: none;
    transition: all 0.15s;
  }
  .tag:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
    text-decoration: none;
  }

  .legacy-stats {
    padding: 1rem;
    background: var(--color-bg);
    border-radius: 0.5rem;
    border: 1px solid var(--color-border);
  }
  .legacy-stats h3 {
    margin: 0 0 0.75rem;
    font-size: 0.8125rem;
    font-weight: 600;
    color: var(--color-text-muted);
  }
  .legacy-stats .captured-date {
    font-weight: 400;
    opacity: 0.7;
  }
  .stats-grid {
    display: flex;
    gap: 1.5rem;
  }
  .stat {
    display: flex;
    flex-direction: column;
  }
  .stat-value {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-text);
  }
  .stat-label {
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: auto;
    padding-top: 1rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    font-size: 0.9375rem;
    font-weight: 600;
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.15s;
  }
  .btn:hover {
    text-decoration: none;
  }
  .btn-primary {
    background: var(--color-primary);
    color: white;
  }
  .btn-primary:hover {
    background: var(--color-primary-dark);
  }
  .btn-secondary {
    background: var(--color-surface);
    color: var(--color-text);
    border: 1px solid var(--color-border);
  }
  .btn-secondary:hover {
    border-color: var(--color-text-muted);
  }

  @media (max-width: 768px) {
    .deck-page {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    h1 {
      font-size: 1.5rem;
    }
    .actions {
      flex-direction: column;
    }
    .btn {
      justify-content: center;
    }
  }

  /* Fullscreen Viewer Modal */
  .viewer-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
  }
  .viewer-modal[hidden] {
    display: none;
  }
  
  .viewer-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    max-width: 1400px;
    height: 100%;
    max-height: calc(100vh - 3rem);
    background: #1a1a1a;
    border-radius: 1rem;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    overflow: hidden;
    animation: modalSlideIn 0.2s ease-out;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
  
  .viewer-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.875rem 1.25rem;
    background: #1a1a1a;
    border-bottom: 1px solid #333;
    flex-shrink: 0;
  }
  
  .viewer-title {
    color: #fff;
    font-size: 0.9375rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-right: 1rem;
  }
  
  .viewer-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
  }
  
  .viewer-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: transparent;
    border: none;
    border-radius: 0.5rem;
    color: #999;
    cursor: pointer;
    transition: all 0.15s;
    text-decoration: none;
  }
  .viewer-btn:hover {
    background: #333;
    color: #fff;
  }
  .viewer-close {
    width: 40px;
    height: 40px;
    margin-left: 0.5rem;
  }
  .viewer-close:hover {
    background: #dc2626;
    color: #fff;
  }
  
  .viewer-body {
    flex: 1;
    min-height: 0;
    display: flex;
    background: #525659;
    border-radius: 0 0 1rem 1rem;
  }
  
  .viewer-iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  @media (max-width: 640px) {
    .viewer-modal {
      padding: 0.75rem;
    }
    .viewer-container {
      max-height: calc(100vh - 1.5rem);
      border-radius: 0.75rem;
    }
    .viewer-header {
      padding: 0.75rem 1rem;
    }
    .viewer-title {
      font-size: 0.875rem;
    }
    .viewer-body {
      border-radius: 0 0 0.75rem 0.75rem;
    }
  }
</style>
